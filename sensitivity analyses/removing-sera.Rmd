---
title: "Removing Sera from map - 3D"
output: html_document
date: "2024-07-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=T, warning = F, message=F)
library(Racmacs)
```

```{r info, echo=F, cache=FALSE}
print(Sys.time())
print(paste("Racmacs", packageVersion("Racmacs")))
```

## Introduction

Removing sera in 3d maps.

## Methods & results

```{r get-data}
map_conservative_sd_1.5_n3_3d <- read.acmap("input/map_conservative_sd_1.5_n3.ace")
```

```{r rm-sera}
maps <- NULL
for (i in 1:numSera(map_conservative_sd_1.5_n3_3d)){
  maps[[i]] <- map_conservative_sd_1.5_n3_3d
  maps[[i]] <- removeSera(maps[[i]], i)
  maps[[i]] <- optimizeMap(maps[[i]], 3, 1000)
}
```

```{r procs}
procs <- NULL
for (i in 1:numSera(map_conservative_sd_1.5_n3_3d)){
  procs[[i]] <- procrustesData(map_conservative_sd_1.5_n3_3d, maps[[i]])
}
```

```{r, fig.dim=c(7,7)}
plot(sapply(procs, "[[", 5))
which(sapply(procs, "[[", 5)>0.8)
```

```{r, fig.dim=c(7,7)}
med_dist <- colMeans(rbind(sapply(procs, "[[", 1),
           sapply(procs, "[[", 2)), na.rm=T)
plot(med_dist)
which(med_dist>0.8)
which(med_dist>0.6)
```

```{r save-files, cache=F}
save(maps, procs, file="output/rm-sr-3d-cons-n3.RData")
write.csv(med_dist, "output/rm-sr-3d-cons-n3-median-dist.csv")
```

[median dist csv](output/rm-sr-3d-cons-n3-median-dist.csv)


```{r more-info, cache=F}
srNames(map_conservative_sd_1.5_n3_3d)[c(5,20,24,26,29)]

# compare 5 to full map
pc <- procrustesMap(map_conservative_sd_1.5_n3_3d, maps[[5]])
view(pc)

# compare 20 to full map
pc <- procrustesMap(map_conservative_sd_1.5_n3_3d, maps[[20]])
view(pc)

# compare 24 to full map
pc <- procrustesMap(map_conservative_sd_1.5_n3_3d, maps[[24]])
view(pc)

# compare 26 to full map
pc <- procrustesMap(map_conservative_sd_1.5_n3_3d, maps[[26]])
view(pc)

# compare 29 to full map
pc <- procrustesMap(map_conservative_sd_1.5_n3_3d, maps[[29]])
view(pc)

```

```{r proc-data}
procrustesData(maps[[5]], maps[[20]])$total_rmsd
procrustesData(maps[[5]], maps[[24]])$total_rmsd
procrustesData(maps[[5]], maps[[26]])$total_rmsd
procrustesData(maps[[5]], maps[[29]])$total_rmsd

procrustesData(maps[[20]], maps[[24]])$total_rmsd
procrustesData(maps[[20]], maps[[26]])$total_rmsd
procrustesData(maps[[20]], maps[[29]])$total_rmsd

procrustesData(maps[[24]], maps[[26]])$total_rmsd
procrustesData(maps[[24]], maps[[29]])$total_rmsd

procrustesData(maps[[26]], maps[[29]])$total_rmsd
```

```{r more-more-info, cache=F}
# 5 vs 24
pc <- procrustesMap(maps[[5]], maps[[24]])
view(pc)

# 5 vs 29
pc <- procrustesMap(maps[[5]], maps[[29]])
view(pc)

# 24 vs 29
pc <- procrustesMap(maps[[24]], maps[[29]])
view(pc)
```

```{r more-more-more-info, cache=F}
# 5 vs 20
pc <- procrustesMap(maps[[5]], maps[[20]])
view(pc)

# 5 vs 26
pc <- procrustesMap(maps[[5]], maps[[26]])
view(pc)
```

## Discussion

3 sera with procrustes median RMSD greater than 0.8

5 sera with procrustes median RMSD greater than 0.6

1. 4 are changes in the light blue cluster (2-3-4-4) +/- additional large movement of a dark blue antigen (classical)
2. 1 is dominated by movement of 2 2-3-2-1 antigens & 1 2-2-2-1 antigen

The map is generally stable, but the 2-3-4-4 cluster internal positioning is not.




